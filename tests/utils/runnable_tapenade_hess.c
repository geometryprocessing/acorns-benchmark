#ifdef _WIN32
    #include <windows.h>
#endif

#include <math.h>
#include <stdlib.h>
#include <inttypes.h>
#include <time.h>
#include <stdio.h>
#include <stdint.h>

void read_file_to_array(char *filename, double *args, int num_params, int num_vars)
{
    FILE *file = fopen(filename, "r");

    if (file != NULL)
    {

        char line[200];
        int i = 0;

        for (int i = 0; i < num_params * num_vars; i++)
        {
            fscanf(file, "%lf", &args[i]);
        }

        fclose(file);
    }
    else
    {
        perror(filename); /* why didn't the file open? */
    }
}

/*        Generated by TAPENADE     (INRIA, Ecuador team)
    Tapenade 3.15 (master) -  8 Jan 2020 10:53
*/
/*
  Differentiation of function_0_d in forward (tangent) mode:
   variations   of useful results: function_0_d *function_0
   with respect to varying inputs: Dd *function_0 D
   RW status of diff variables: Dd:in function_0_d:out *function_0:in-out
                D:in
   Plus diff mem management of: function_0:in

        Generated by TAPENADE     (INRIA, Ecuador team)
    Tapenade 3.15 (master) -  8 Jan 2020 10:53


  Differentiation of function_0 in forward (tangent) mode:
   variations   of useful results: function_0
   with respect to varying inputs: D
   RW status of diff variables: function_0:out D:in
*/
double function_0_d_d(double D, double Dd0, double Dd, double Ddd, double *
        function_0, double *function_0d, double *function_0_d) {
    double p = 4*(D*(1-D));
    double pd0 = 4*(1-2*D)*Dd0;
    double pd = 4*(1-2*D)*Dd;
    double pdd = 4*((1-2*D)*Ddd-Dd*2*Dd0);
    *function_0d = pd0;
    *function_0 = p;
    *function_0_d = pd;
    return pdd;
}


/*
    Expects command line arguments: num_params num_vars params_filename output_filename
*/
int main(int argc, char *argv[])
{

    printf("I am running...");

    // read command line arguments
    char *ptr;

    int num_params = (int)strtol(argv[1], &ptr, 10);
    int num_vars = (int)strtol(argv[2], &ptr, 10);
    int num_ders = (num_vars * num_vars);
    char *params_filename = argv[3];
    char *output_filename = argv[4];

    double *values = malloc(num_params * num_vars * sizeof(double));
    double *ders = malloc(num_params * num_ders * sizeof(double));

    read_file_to_array(params_filename, values, num_params, num_vars);

#ifdef _WIN32

    LARGE_INTEGER StartingTime, EndingTime, ElapsedMicroseconds;
    LARGE_INTEGER Frequency;

    QueryPerformanceFrequency(&Frequency);
    QueryPerformanceCounter(&StartingTime);

    // Activity to be timed

    compute(values, num_params, ders);

    QueryPerformanceCounter(&EndingTime);
    ElapsedMicroseconds.QuadPart = EndingTime.QuadPart - StartingTime.QuadPart;

    // ElapsedMicroseconds.QuadPart *= 1000000;
    // ElapsedMicroseconds.QuadPart /= Frequency.QuadPart;

    double delta = (ElapsedMicroseconds.QuadPart) / (double)Frequency.QuadPart; // seconds

#else

    double ders_flags[1][1];
    for (int i = 0; i < num_vars; i++) {
        for (int j = 0; j < num_vars; j++) {
            if (i == j) {
                ders_flags[i][j] = (double) 1;
            } else {
                ders_flags[i][j] = (double) 0;
            }
        }
    }

    double Ddd = 0;
	

    double function_d = 0;
    double function_0d = 0;
    double function_0_d = 0;
    struct timespec tstart = {0, 0}, tend = {0, 0};
    clock_gettime(CLOCK_MONOTONIC, &tstart);
    for (int i = 0; i < num_params; i++) {
        		double D = values[i * 1 + 0];

        for (int first_der = 0; first_der < num_vars; first_der++) {
            for (int second_der = 0; second_der <= first_der; second_der++) {
                		double output = function_0_d_d(D, ders_flags[second_der][0], ders_flags[first_der][0], Ddd,&function_0_d, &function_0d, &function_0_d);

                ders[first_der*num_vars+second_der + (num_vars*num_vars) * i] = output;
                ders[second_der*num_vars+first_der + (num_vars*num_vars) * i] = output;
            }

        }
    }
    clock_gettime(CLOCK_MONOTONIC, &tend);
    double delta = ((double)tend.tv_sec + 1.0e-9 * tend.tv_nsec) - ((double)tstart.tv_sec + 1.0e-9 * tstart.tv_nsec); // seconds
#endif

    FILE *fp;

    fp = fopen(output_filename, "w+");
    // printf("%f ", delta);
    fprintf(fp, "%f ", delta);

    for (int i = 0; i < num_params * num_ders; i++)
    {
        fprintf(fp, "%f ", ders[i]);
        // printf("%f", ders[i]);
    }
    fclose(fp);
    return 0;
}